import numpy as np

from qvl.qlabs import QuanserInteractiveLabs

from tests.performance_environment import destroy_map
from tests.performance_environment import prepare_test_environment
from core.policies.pt_policy import PTPolicy
from .dataset import D4RLTrajectoryDataset
from .vehicle import ReinformerCar, ReinformerPolicy
from .reinformer import ReinFormer
from .settings import *


def test_reinformer_car() -> None:
    # prepare environment
    destroy_map()
    waypoints: np.ndarray = prepare_test_environment()
    # nn module
    model: ReinFormer = ReinFormer(
        state_dim=STATE_DIM,
        act_dim=ACT_DIM,
        n_blocks=N_BLOCKS,
        h_dim=EMBED_DIM,
        context_len=CONTEXT_LEN,
        n_heads=N_HEADS,
        drop_p=DROPOUT_P,
        init_temperature=INIT_TEMPERATURE,
        target_entropy=-ACT_DIM,
    ).to(DEVICE)
    # prepare policy
    max_steps: int = 100000
    state_mean: np.ndarray = np.array([
        5.92032296e-04, -2.55293943e-02, 1.05235743e-02, -2.55038975e-02, 2.04322489e-02, -2.54604378e-02, 3.03334093e-02, -2.53976924e-02, 4.02378724e-02, -2.53086539e-02, 5.01244104e-02, -2.52023001e-02, 6.00134653e-02, -2.50759274e-02, 6.98924965e-02, -2.49265190e-02, 7.97651089e-02, -2.47549471e-02, 8.96287038e-02, -2.45629616e-02, 9.94818842e-02, -2.43497076e-02, 1.09327302e-01, -2.41150536e-02, 1.19158447e-01, -2.38608990e-02, 1.28990423e-01, -2.33409553e-02, 1.38820015e-01, -2.30832246e-02, 1.48615979e-01, -2.27659397e-02, 1.58398750e-01, -2.24265540e-02, 1.68163543e-01, -2.20677249e-02, 1.77911223e-01, -2.16888363e-02, 1.87642199e-01, -2.12856906e-02, 1.97358278e-01, -2.08597041e-02, 2.07056800e-01, -2.04148025e-02, 2.16719681e-01, -1.99532852e-02, 2.26370696e-01, -1.94678682e-02, 2.36000180e-01, -1.89627263e-02, 2.45618090e-01, -1.84138950e-02, 2.55204086e-01, -1.78644834e-02, 2.64763645e-01, -1.72933390e-02, 2.74303501e-01, -1.67027276e-02, 2.83806978e-01, -1.60953664e-02, 2.93293504e-01, -1.54642650e-02, 3.02666751e-01, -1.47702941e-02, 3.12093142e-01, -1.41005167e-02, 3.21496633e-01, -1.34089465e-02, 3.30870672e-01, -1.26988315e-02, 3.40222794e-01, -1.19675237e-02, 3.49545008e-01, -1.12165560e-02, 3.58819537e-01, -1.04478681e-02, 3.68074705e-01, -9.65780369e-03, 3.77304297e-01, -8.84854716e-03, 3.86490989e-01, -8.02223847e-03, 3.95648631e-01, -7.17331247e-03, 4.04775588e-01, -6.30843484e-03, 4.13871388e-01, -5.41838756e-03, 4.22923924e-01, -4.51214291e-03, 4.31943275e-01, -3.58783101e-03, 4.40930499e-01, -2.64379633e-03, 4.49883040e-01, -1.68213092e-03, 4.58721551e-01, -6.29428741e-04, 4.67591592e-01, 3.66639961e-04, 4.76431216e-01, 1.38448377e-03, 4.85233241e-01, 2.41380767e-03, 4.93996359e-01, 3.46435399e-03, 5.02719262e-01, 4.53114008e-03, 5.11403979e-01, 5.61694999e-03, 5.20052003e-01, 6.71967610e-03, 5.28657663e-01, 7.83850020e-03, 
        5.37222056e-01, 8.97551476e-03, 5.45748122e-01, 1.01269603e-02, 5.54230996e-01, 1.12960985e-02, 5.62679371e-01, 1.24823691e-02, 5.71077177e-01, 1.36825217e-02, 5.79434131e-01, 1.48986218e-02, 5.87752109e-01, 1.61314629e-02, 5.96027490e-01, 1.73792458e-02, 6.04258074e-01, 1.86440202e-02, 6.12446137e-01, 1.99239981e-02, 6.20589216e-01, 2.12153016e-02, 6.28693621e-01, 2.25235826e-02, 6.36750368e-01, 2.38457659e-02, 6.44765452e-01, 2.51806213e-02, 6.52734198e-01, 2.65305310e-02, 6.60659444e-01, 2.78966822e-02, 6.68541397e-01, 2.92741887e-02, 6.76374537e-01, 3.06653380e-02, 6.84170979e-01, 3.20707673e-02, 6.91911033e-01, 3.34888457e-02, 6.99609156e-01, 3.49201536e-02, 7.07261889e-01, 3.63628837e-02, 7.14871315e-01, 3.78194709e-02, 7.22432953e-01, 3.92904360e-02, 7.29951625e-01, 4.07706859e-02, 7.37421801e-01, 4.22640867e-02, 7.44843408e-01, 4.37680264e-02, 7.52219016e-01, 4.52854023e-02, 7.59548850e-01, 4.68121115e-02, 7.66831187e-01, 4.83520538e-02, 7.74071688e-01, 4.99030506e-02, 7.81256182e-01, 5.14621298e-02, 7.88396094e-01, 5.30317243e-02, 7.95490792e-01, 5.46121332e-02, 8.02538598e-01, 5.62036744e-02, 8.09546029e-01, 5.78060016e-02, 8.16436662e-01, 5.94640928e-02, 8.23340400e-01, 6.10851047e-02, 8.30198456e-01, 6.27124331e-02, 8.37003183e-01, 6.43576226e-02, 8.43737854e-01, 6.60318160e-02, 8.50358773e-01, 6.77049551e-02, 8.56718119e-01, 6.95805237e-02, 8.62638355e-01, 7.17269916e-02, 8.68445433e-01, 7.39329579e-02, 8.74188464e-01, 7.61461373e-02, 8.79856965e-01, 7.83338310e-02, 8.85460393e-01, 8.05915791e-02, 8.90955988e-01, 8.27776365e-02, 8.96435359e-01, 8.49968311e-02, 9.01903019e-01, 8.72741466e-02, 9.07212105e-01, 8.94940059e-02, 9.12535970e-01, 9.17552647e-02, 9.17743293e-01, 9.38969816e-02, 9.22908753e-01, 9.61669042e-02, 9.27993644e-01, 9.84963629e-02, 9.32974991e-01, 1.00749961e-01, 9.37931809e-01, 1.03036955e-01, 9.42808427e-01, 
        1.05394291e-01, 9.47638014e-01, 1.07653091e-01, 9.52376145e-01, 1.10035043e-01, 9.57081127e-01, 1.12351359e-01, 9.61654395e-01, 1.14583341e-01, 9.66163079e-01, 1.16905495e-01, 9.70725004e-01, 1.19238947e-01, 9.75086694e-01, 1.21537724e-01, 9.79428371e-01, 1.23843259e-01, 9.83739743e-01, 1.26174948e-01, 9.88042247e-01, 1.28549578e-01, 9.92195405e-01, 1.30926567e-01, 9.96281593e-01, 1.33273542e-01, 1.00034227e+00, 1.35663593e-01, 1.00436768e+00, 1.37994934e-01, 1.00826904e+00, 1.40360157e-01, 1.01204762e+00, 1.42747259e-01, 1.01585790e+00, 1.45109395e-01, 1.01959483e+00, 1.47493273e-01, 1.02333402e+00, 1.49906380e-01, 1.02688286e+00, 1.52317967e-01, 1.03042280e+00, 1.54646733e-01, 1.03390435e+00, 1.57024945e-01, 1.03737337e+00, 1.59352978e-01, 1.04075044e+00, 1.61759446e-01, 1.04409366e+00, 1.64200508e-01, 1.04732690e+00, 1.66604092e-01, 1.05050153e+00, 1.68980183e-01, 1.05359221e+00, 1.71431431e-01, 1.05665855e+00, 1.73863017e-01, 1.05971902e+00, 1.76219949e-01, 1.06265014e+00, 1.78638808e-01, 1.06551095e+00, 1.81050422e-01, 1.06836145e+00, 1.83494200e-01, 1.07104946e+00, 1.85933143e-01, 1.07381416e+00, 1.88339150e-01, 1.07647014e+00, 1.90742784e-01, 1.07900883e+00, 1.93236035e-01, 1.08158397e+00, 1.95628435e-01, 1.08406051e+00, 1.98084504e-01, 1.08641706e+00, 2.00621340e-01, 1.08882436e+00, 2.03035182e-01, 1.09111737e+00, 2.05412861e-01, 1.09338538e+00, 2.07879116e-01, 1.09550652e+00, 2.10262096e-01, 1.09764945e+00, 2.12736376e-01, 1.09960100e+00, 2.15118021e-01, 1.10161162e+00, 2.17446450e-01, 1.10354485e+00, 2.19905512e-01, 1.10539719e+00, 2.22359178e-01, 1.10728245e+00, 2.24822537e-01, 1.10905775e+00, 2.27243579e-01, 1.11080695e+00, 2.29611828e-01, 1.11244552e+00, 2.31999220e-01, 1.11413058e+00, 2.34380260e-01, 1.11568972e+00, 2.36869730e-01, 1.11727714e+00, 2.39276056e-01, 1.11879861e+00, 2.41668719e-01, 1.12023246e+00, 2.44087460e-01, 
        1.12165076e+00, 2.46544573e-01, 1.12305452e+00, 2.48977608e-01, 1.12431984e+00, 2.51386804e-01, 1.12559860e+00, 2.53815108e-01, 1.12676696e+00, 2.56199730e-01, 1.12793460e+00, 2.58672480e-01, 1.12899483e+00, 2.61033631e-01, 1.13009980e+00, 2.63454776e-01, 1.13105941e+00, 2.65865560e-01, 1.13204967e+00, 2.68224327e-01, 1.13299012e+00, 2.70680742e-01, 1.13385396e+00, 2.73068761e-01, 1.13465023e+00, 2.75496435e-01, 1.13548310e+00, 2.77871428e-01, 1.13623912e+00, 2.80222467e-01, 1.13697364e+00, 2.82574907e-01, 1.13760405e+00, 2.84948921e-01, 1.13825966e+00, 2.87391259e-01, 1.13883327e+00, 2.89745506e-01, 1.13940648e+00, 2.92118726e-01, 1.13985649e+00, 2.94539145e-01, 1.14031138e+00, 2.96926278e-01, 1.14066628e+00, 2.99335701e-01, 1.14112519e+00, 3.01683902e-01, 1.14140150e+00, 3.04056039e-01, 1.14168204e+00, 3.06434266e-01, 6.77535829e-01, 1.66936747e+00, -1.09737105e-02, 1.39732982e+00, -2.07677849e-03, -2.34861420e-01, 1.07144862e+01, 1.07623913e+01, 1.03430901e+01, 4.75739982e+00, -3.18091383e+00, -3.10603931e+01, -4.97700269e+01, -6.35840931e+01, -8.15255117e+01, -9.74486873e+01, -9.81310063e+01, -9.85832826e+01, -9.90000000e+01, -9.90000000e+01, -9.90000000e+01
    ])
    state_std: np.ndarray = np.array([
        3.39791793e-01, 4.91412213e-01, 3.39945267e-01, 4.91463819e-01, 3.40082090e-01, 4.91506984e-01, 3.40230152e-01, 4.91553112e-01, 3.40230174e-01, 4.91485911e-01, 3.40541060e-01, 4.91656525e-01, 3.40701150e-01, 4.91713822e-01, 3.40866569e-01, 4.91777242e-01, 3.41031020e-01, 4.91843801e-01, 3.41215422e-01, 4.91905127e-01, 3.41389836e-01, 4.91980331e-01, 3.41576350e-01, 4.92069928e-01, 3.41754652e-01, 4.92154473e-01, 3.41832929e-01, 4.92782727e-01, 3.42059819e-01, 4.92897740e-01, 3.42256485e-01, 4.93000028e-01, 3.42454120e-01, 4.93115739e-01, 3.42657122e-01, 4.93242382e-01, 3.42861753e-01, 4.93377642e-01, 3.43074009e-01, 4.93528103e-01, 3.43142046e-01, 4.93577799e-01, 3.43205182e-01, 4.93635595e-01, 3.43736540e-01, 4.94066386e-01, 3.43963639e-01, 4.94275939e-01, 3.44196857e-01, 4.94502762e-01, 3.44430304e-01, 4.94794577e-01, 3.44669682e-01, 4.95059618e-01, 3.44914530e-01, 4.95348129e-01, 3.45010860e-01, 4.95542635e-01, 3.45423554e-01, 4.95988908e-01, 3.45680040e-01, 4.96346319e-01, 3.45787416e-01, 4.96686486e-01, 3.46206223e-01, 4.97210004e-01, 3.46479891e-01, 4.97645552e-01, 3.46756712e-01, 4.98107384e-01, 3.46884369e-01, 4.98479642e-01, 3.47017042e-01, 4.98886081e-01, 3.47615484e-01, 4.99677601e-01, 3.47914122e-01, 5.00267586e-01, 3.48067965e-01, 5.00773268e-01, 3.48527546e-01, 5.01548101e-01, 3.48843353e-01, 5.02246363e-01, 3.49288808e-01, 5.03060586e-01, 3.49460060e-01, 5.03721180e-01, 3.49937321e-01, 5.04657191e-01, 3.50277294e-01, 5.05511764e-01, 3.50619037e-01, 5.06412142e-01, 3.50965133e-01, 5.07349589e-01, 3.50523288e-01, 5.07916822e-01, 3.51042802e-01, 5.09060577e-01, 3.51413889e-01, 5.10135898e-01, 3.51792141e-01, 5.11256607e-01, 3.52177207e-01, 5.12425518e-01, 3.52577307e-01, 5.13646390e-01, 3.52982535e-01, 5.14920224e-01, 3.53385481e-01, 5.16242453e-01, 3.53808604e-01, 5.17613461e-01, 3.54237743e-01, 5.19041997e-01, 3.54673089e-01, 
        5.20518328e-01, 3.55125316e-01, 5.22051636e-01, 3.55434493e-01, 5.23527253e-01, 3.56050887e-01, 5.25280198e-01, 3.56533952e-01, 5.26975041e-01, 3.57016891e-01, 5.28728549e-01, 3.57514110e-01, 5.30541198e-01, 3.58030036e-01, 5.32407718e-01, 3.58556506e-01, 5.34333193e-01, 3.59098440e-01, 5.36317034e-01, 3.59643688e-01, 5.38357587e-01, 3.60209538e-01, 5.40455334e-01, 3.60783436e-01, 5.42612084e-01, 3.61379633e-01, 5.44827945e-01, 3.61988636e-01, 5.47105846e-01, 3.62605526e-01, 5.49442646e-01, 3.63251776e-01, 5.51840809e-01, 3.63753904e-01, 5.54192341e-01, 3.64576689e-01, 5.56813090e-01, 3.65265137e-01, 5.59390530e-01, 3.65978919e-01, 5.62027291e-01, 3.66696490e-01, 5.64723719e-01, 3.67443706e-01, 5.67478812e-01, 3.68199677e-01, 5.70295808e-01, 3.68979709e-01, 5.73169440e-01, 3.69785560e-01, 5.76103038e-01, 3.70611003e-01, 5.79097526e-01, 3.71448816e-01, 5.82146330e-01, 3.72317447e-01, 5.85258342e-01, 3.73060568e-01, 5.88328526e-01, 3.74118249e-01, 5.91651778e-01, 3.75057661e-01, 5.94935166e-01, 3.76015833e-01, 5.98272271e-01, 3.76999237e-01, 6.01666137e-01, 3.77854379e-01, 6.05022399e-01, 3.78988525e-01, 6.08578481e-01, 3.80056651e-01, 6.12145191e-01, 3.81162552e-01, 6.15802709e-01, 3.82368868e-01, 6.19567282e-01, 3.83822892e-01, 6.23602192e-01, 3.85355746e-01, 6.27656019e-01, 3.88573699e-01, 6.33136285e-01, 3.95971590e-01, 6.42049028e-01, 4.03209827e-01, 6.51001704e-01, 4.10199483e-01, 6.59654734e-01, 4.17538652e-01, 6.68554309e-01, 4.24758177e-01, 6.77290150e-01, 4.31715833e-01, 6.85855093e-01, 4.38628310e-01, 6.94385581e-01, 4.45435899e-01, 7.03085840e-01, 4.52517720e-01, 7.11720263e-01, 4.59230862e-01, 7.20126979e-01, 4.66304317e-01, 7.28562041e-01, 4.72903755e-01, 7.36894517e-01, 4.79537998e-01, 7.45244339e-01, 4.86296430e-01, 7.53514354e-01, 4.93010193e-01, 7.61718054e-01, 4.99578289e-01, 7.69885484e-01, 5.06167487e-01, 7.77830091e-01, 
        5.12812764e-01, 7.86131701e-01, 5.19420552e-01, 7.94194818e-01, 5.26216267e-01, 8.02268431e-01, 5.32741168e-01, 8.10369733e-01, 5.39240852e-01, 8.18313030e-01, 5.45847069e-01, 8.26549724e-01, 5.52519440e-01, 8.34595195e-01, 5.58922441e-01, 8.42462744e-01, 5.65257642e-01, 8.50247424e-01, 5.71712430e-01, 8.58117912e-01, 5.78054786e-01, 8.65996767e-01, 5.84487643e-01, 8.73862762e-01, 5.90832283e-01, 8.81482581e-01, 5.97277554e-01, 8.89167551e-01, 6.03810131e-01, 8.96944037e-01, 6.10126318e-01, 9.04585696e-01, 6.16568676e-01, 9.12266887e-01, 6.22699144e-01, 9.19788766e-01, 6.29086282e-01, 9.27421608e-01, 6.35419233e-01, 9.34974305e-01, 6.41641038e-01, 9.42464291e-01, 6.47790751e-01, 9.49818973e-01, 6.54053121e-01, 9.57464595e-01, 6.60134406e-01, 9.64834298e-01, 6.66511836e-01, 9.72274892e-01, 6.72701821e-01, 9.79644832e-01, 6.79038580e-01, 9.87133487e-01, 6.85252656e-01, 9.94520677e-01, 6.91315421e-01, 1.00171224e+00, 6.97550751e-01, 1.00893292e+00, 7.03829755e-01, 1.01617472e+00, 7.10032818e-01, 1.02324144e+00, 7.16451189e-01, 1.03066515e+00, 7.22575605e-01, 1.03772150e+00, 7.28674612e-01, 1.04496471e+00, 7.34967499e-01, 1.05212509e+00, 7.41029677e-01, 1.05914944e+00, 7.47234926e-01, 1.06629168e+00, 7.53673399e-01, 1.07344858e+00, 7.59524940e-01, 1.08042039e+00, 7.65729832e-01, 1.08733759e+00, 7.71837076e-01, 1.09425871e+00, 7.78101139e-01, 1.10116419e+00, 7.84485029e-01, 1.10804578e+00, 7.91035710e-01, 1.11504305e+00, 7.97101965e-01, 1.12182937e+00, 8.03313638e-01, 1.12868732e+00, 8.09666253e-01, 1.13553612e+00, 8.15649799e-01, 1.14223090e+00, 8.21871874e-01, 1.14899785e+00, 8.28112467e-01, 1.15578493e+00, 8.34364783e-01, 1.16259479e+00, 8.40451047e-01, 1.16932485e+00, 8.46617408e-01, 1.17596034e+00, 8.52778451e-01, 1.18254421e+00, 8.58804022e-01, 1.18918963e+00, 8.65025346e-01, 1.19570006e+00, 8.71133393e-01, 1.20224882e+00, 8.77214502e-01, 
        1.20870377e+00, 8.83369905e-01, 1.21518256e+00, 8.89415812e-01, 1.22164252e+00, 8.95565496e-01, 1.22815722e+00, 9.01656651e-01, 1.23449740e+00, 9.07920234e-01, 1.24081022e+00, 9.13860041e-01, 1.24714015e+00, 9.20220039e-01, 1.25353555e+00, 9.26251177e-01, 1.25991159e+00, 9.32303525e-01, 1.26620466e+00, 9.38358182e-01, 1.27254817e+00, 9.44488650e-01, 1.27872991e+00, 9.50473757e-01, 1.28487179e+00, 9.56579804e-01, 1.29099086e+00, 9.62669711e-01, 1.29704150e+00, 9.68681012e-01, 1.30319887e+00, 9.74791421e-01, 1.30933531e+00, 9.80905773e-01, 1.31548970e+00, 9.86769548e-01, 1.32152853e+00, 9.92915028e-01, 1.32751211e+00, 9.98916928e-01, 1.33351517e+00, 1.00502745e+00, 1.33951375e+00, 1.01094497e+00, 1.34542092e+00, 1.01698607e+00, 1.35136903e+00, 1.02299549e+00, 1.35714333e+00, 1.38261289e+00, 1.78380260e+00, 1.81997275e+00, 9.16109106e-01, 3.46324845e+01, 1.35229906e+02, 6.93724061e+00, 7.11406579e+00, 6.59914047e+00, 2.58195401e+01, 3.81070870e+01, 5.41403299e+01, 5.50460545e+01, 5.16139939e+01, 4.01221427e+01, 1.28678782e+01, 9.72386862e+00, 6.80143880e+00, 1.00000000e-06, 1.00000000e-06, 1.00000000e-06    
    ])
    policy: PTPolicy = ReinformerPolicy(model, model_path=MODEL_PATH)
    policy.setup(
        eval_batch_size=1,
        max_test_ep_len=max_steps,
        context_len=CONTEXT_LEN,
        state_mean=state_mean, # how to get this when deploy on a real car?
        state_std=state_std, # how to get this when deploy on a real car?
        state_dim=STATE_DIM,
        act_dim=ACT_DIM,
        device=DEVICE,
    )
    # prepare car
    counter: int = 0
    actor_id: int = 0
    dt: float = 0.0165
    qlabs: QuanserInteractiveLabs = QuanserInteractiveLabs()
    qlabs.open('localhost')
    car: ReinformerCar = ReinformerCar(
        actor_id=actor_id,
        dt=dt,
        qlabs=qlabs,
        throttle_coeff=0.08,
        steering_coeff=0.5,
    )
    car.setup(
        task=[4, 14, 20], # [20, 22],
        waypoints=waypoints, 
        init_waypoint_index=0, 
        policy=policy
    )
    # start the simulation
    while counter <= 100000:
        car.execute()
        counter += 1
    car.running_gear.read_write_std(0, 0)
    