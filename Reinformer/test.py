import numpy as np

from qvl.qlabs import QuanserInteractiveLabs

from tests.performance_environment import destroy_map
from tests.performance_environment import prepare_test_environment
from core.policies.pt_policy import PTPolicy
from .dataset import D4RLTrajectoryDataset
from .vehicle import ReinformerCar, ReinformerPolicy
from .reinformer import ReinFormer
from .settings import *


def test_reinformer_car() -> None:
    # prepare environment
    destroy_map()
    waypoints: np.ndarray = prepare_test_environment(node_id=4)
    # nn module
    model: ReinFormer = ReinFormer(
        state_dim=STATE_DIM,
        act_dim=ACT_DIM,
        n_blocks=N_BLOCKS,
        h_dim=EMBED_DIM,
        context_len=CONTEXT_LEN,
        n_heads=N_HEADS,
        drop_p=DROPOUT_P,
        init_temperature=INIT_TEMPERATURE,
        target_entropy=-ACT_DIM,
    ).to(DEVICE)
    # prepare policy
    max_steps: int = 100000
    state_mean: np.ndarray = np.array([
        # 4.29506613e-06, -1.55903485e-03, 1.00284099e-02, -1.54011896e-03, 2.00235243e-02, -1.49873045e-03, 3.00143817e-02, -1.43551753e-03, 
        # 4.00014132e-02, -1.34992234e-03, 4.99830984e-02, -1.24216506e-03, 5.99570543e-02, -1.11212241e-03, 6.99236708e-02, -9.60169571e-04, 
        # 7.98823151e-02, -7.85940594e-04, 8.98324801e-02, -5.89457910e-04, 9.97718003e-02, -3.70999189e-04, 1.09699242e-01, -1.30546748e-04, 
        # 1.19614473e-01, 1.32369447e-04, 1.29517018e-01, 4.16948158e-04, 1.39405190e-01, 7.23563818e-04, 1.49278807e-01, 1.05208135e-03, 
        # 1.59140728e-01, 1.40276641e-03, 1.68981879e-01, 1.77534697e-03, 1.78809968e-01, 2.16973064e-03, 1.88617824e-01, 2.58568005e-03, 
        # 1.98408118e-01, 3.02348175e-03, 2.08177147e-01, 3.48347440e-03, 2.17927063e-01, 3.96460314e-03, 2.27652872e-01, 4.46803224e-03, 
        # 2.37359113e-01, 4.99254935e-03, 2.47040909e-01, 5.53894158e-03, 2.56700927e-01, 6.10691644e-03, 2.66335172e-01, 6.69606802e-03, 
        # 2.75945701e-01, 7.30714131e-03, 2.85530417e-01, 7.93849329e-03, 2.95088465e-01, 8.59178149e-03, 3.04620799e-01, 9.26678807e-03, 
        # 3.14125950e-01, 9.96224307e-03, 3.23600654e-01, 1.06778797e-02, 3.33047829e-01, 1.14153730e-02, 3.42465075e-01, 1.21726586e-02, 
        # 3.51851951e-01, 1.29511001e-02, 3.61208198e-01, 1.37489961e-02, 3.70533829e-01, 1.45689392e-02, 3.79828500e-01, 1.54076563e-02, 
        # 3.89090376e-01, 1.62668065e-02, 3.98317743e-01, 1.71457451e-02, 4.07510936e-01, 1.80445334e-02, 4.16670554e-01, 1.89630687e-02, 
        # 4.25795929e-01, 1.99023964e-02, 4.34883844e-01, 2.08596695e-02, 4.43939099e-01, 2.18365193e-02, 4.52956944e-01, 2.28321893e-02, 
        # 4.61938195e-01, 2.38468718e-02, 4.70882853e-01, 2.48810476e-02, 4.79787352e-01, 2.59331307e-02, 4.88654782e-01, 2.70033837e-02, 
        # 4.97484360e-01, 2.80910542e-02, 5.06275076e-01, 2.91985526e-02, 5.15026921e-01, 3.03232178e-02, 5.23737623e-01, 3.14652916e-02, 
        # 5.32409114e-01, 3.26246103e-02, 5.41038606e-01, 3.38018272e-02, 5.49629545e-01, 3.49966979e-02, 5.58177675e-01, 3.62086377e-02, 
        # 5.66684683e-01, 3.74354383e-02, 5.75150706e-01, 3.86807402e-02, 5.83574020e-01, 3.99425760e-02, 5.91954833e-01, 4.12197825e-02, 
        # 6.00291991e-01, 4.25137906e-02, 6.08586052e-01, 4.38224218e-02, 6.16840518e-01, 4.51482678e-02, 6.25047010e-01, 4.64881844e-02, 
        # 6.33210581e-01, 4.78444721e-02, 6.41330498e-01, 4.92147321e-02, 6.49406457e-01, 5.05997176e-02, 6.57437829e-01, 5.19994402e-02, 
        # 6.65424891e-01, 5.34130371e-02, 6.73365527e-01, 5.48408817e-02, 6.81261993e-01, 5.62829118e-02, 6.89112820e-01, 5.77387610e-02, 6.96917569e-01, 
        # 5.92084124e-02, 7.04676804e-01, 6.06907654e-02, 7.12388919e-01, 6.21864448e-02, 7.20056322e-01, 6.36959453e-02, 7.27677327e-01, 
        # 6.52169241e-02, 7.35251395e-01, 6.67509152e-02, 7.42780084e-01, 6.82968268e-02, 7.50261723e-01, 6.98552450e-02, 7.57694987e-01, 
        # 7.14248578e-02, 7.65080933e-01, 7.30061767e-02, 7.72421092e-01, 7.45999812e-02, 7.79715201e-01, 7.62034480e-02, 7.86960782e-01, 
        # 7.78186727e-02, 7.94158254e-01, 7.94431838e-02, 8.01308594e-01, 8.10788621e-02, 8.08412639e-01, 8.27248866e-02, 8.15467583e-01, 
        # 8.43808115e-02, 8.22475965e-01, 8.60466180e-02, 8.29435410e-01, 8.77225935e-02, 8.36347796e-01, 8.94037581e-02, 8.43212899e-01, 
        # 9.10960504e-02, 8.50029956e-01, 9.27991800e-02, 8.56797997e-01, 9.45114191e-02, 8.63073983e-01, 9.63926559e-02, 8.69022319e-01, 
        # 9.85377838e-02, 8.74642489e-01, 1.00735272e-01, 8.80317474e-01, 1.02780147e-01, 8.86057191e-01, 1.05042479e-01, 8.91718963e-01, 
        # 1.07159777e-01, 8.97048492e-01, 1.09554139e-01, 9.02595356e-01, 1.11584343e-01, 9.07947416e-01, 1.13786831e-01, 9.13322214e-01, 
        # 1.16095570e-01, 9.18518801e-01, 1.18252575e-01, 9.23729172e-01, 1.20420984e-01, 9.29032259e-01, 1.22695193e-01, 9.33974039e-01, 1.24944904e-01, 
        # 9.39053318e-01, 1.27232310e-01, 9.43904202e-01, 1.29571610e-01, 9.48770423e-01, 1.31652952e-01, 9.53723055e-01, 1.33831580e-01, 
        # 9.58467412e-01, 1.36163095e-01, 9.63097737e-01, 1.38444031e-01, 9.67766615e-01, 1.40617326e-01, 9.72334639e-01, 1.42887757e-01,
        #  9.76881623e-01, 1.44982250e-01, 9.81169226e-01, 1.47246004e-01, 9.85304851e-01, 1.49407243e-01, 9.89677460e-01, 1.51475490e-01, 9.93939722e-01, 1.53879844e-01, 9.98160543e-01, 1.56173269e-01, 1.00227636e+00, 1.58571876e-01, 1.00646412e+00, 1.60709726e-01, 1.01049349e+00, 1.62848536e-01, 1.01430544e+00, 1.65168627e-01, 1.01806480e+00, 1.67523528e-01, 1.02206116e+00, 1.69642417e-01, 1.02569515e+00, 1.71960002e-01, 1.02954363e+00, 1.74372708e-01, 1.03314012e+00, 1.76598253e-01, 1.03671037e+00, 1.78944716e-01, 1.04019410e+00, 1.81096695e-01, 1.04370118e+00, 1.83383095e-01, 1.04706379e+00, 1.85682788e-01, 1.05063123e+00, 1.87957731e-01, 1.05388415e+00, 1.90271961e-01, 1.05704614e+00, 1.92412010e-01, 1.06017350e+00, 1.94878639e-01, 1.06332013e+00, 1.96980936e-01, 1.06637804e+00, 1.99298437e-01, 1.06939395e+00, 2.01482265e-01, 1.07224380e+00, 2.03792393e-01, 1.07527186e+00, 2.06160581e-01, 1.07795654e+00, 
        # 2.08528197e-01, 1.08079005e+00, 2.10759361e-01, 1.08355490e+00, 2.13080850e-01, 1.08612062e+00, 2.15261609e-01, 1.08873727e+00, 
        # 2.17581694e-01, 1.09115229e+00, 2.20026038e-01, 1.09368311e+00, 2.22553213e-01, 1.09610659e+00, 2.24848307e-01, 1.09839765e+00, 
        # 2.27231682e-01, 1.10057437e+00, 2.29595649e-01, 1.10281133e+00, 2.31929261e-01, 1.10488615e+00, 2.34338441e-01, 1.10675849e+00, 
        # 2.36488337e-01, 1.10892801e+00, 2.38813789e-01, 1.11102016e+00, 2.41136767e-01, 1.11288635e+00, 2.43506915e-01, 1.11481554e+00, 
        # 2.45974880e-01, 1.11665293e+00, 2.48139084e-01, 1.11850963e+00, 2.50599969e-01, 1.12037326e+00, 2.52839177e-01, 1.12193003e+00, 
        # 2.55253486e-01, 1.12351096e+00, 2.57645697e-01, 1.12515470e+00, 2.59963238e-01, 1.12683432e+00, 2.62228817e-01, 1.12832498e+00, 
        # 2.64768297e-01, 1.12965613e+00, 2.66909431e-01, 1.13123306e+00, 2.69470272e-01, 1.13269038e+00, 2.71859351e-01, 1.13382253e+00, 
        # 2.74162134e-01, 1.13507471e+00, 2.76270102e-01, 1.13646840e+00, 2.78844982e-01, 1.13756334e+00, 2.81235981e-01, 1.13869237e+00, 
        # 2.83726066e-01, 1.13970428e+00, 2.85990150e-01, 1.14093136e+00, 2.88360176e-01, 1.14187297e+00, 2.90863909e-01, 1.14292133e+00, 2.93283934e-01, 
        # 1.14368459e+00, 2.95646381e-01, 1.14485051e+00, 2.98018224e-01, 1.14547475e+00, 3.00454443e-01, 1.14630940e+00, 3.02770900e-01, 
        # 1.14738723e+00, 3.05090841e-01, 1.14800238e+00, 3.07564073e-01, 1.14854700e+00, 3.09784781e-01, 1.14924902e+00, 3.12236728e-01, 
        # 1.14981376e+00, 3.14613744e-01, 1.15045254e+00, 3.17000384e-01, 1.15089581e+00, 3.19459482e-01, 1.15156245e+00, 3.21735421e-01, 
        # 1.15199196e+00, 3.24296214e-01, 1.15217439e+00, 3.26717532e-01, 1.13513432e+01, 9.86472504e+00, 9.04090609e+00, 1.11362293e+01, 
        # 1.28114919e+01, 7.45044774e+00, 4.30277395e+00, 2.64708541e+00, 8.30448884e-01, 3.81163538e-01, 3.90986453e-01, 0.00000000e+00, 0.00000000e+00, 0.00000000e+00, 0.00000000e+00    
    
        4.42642742e-06, -1.58008528e-03, 1.00285242e-02, -1.56116951e-03, 2.00238162e-02, -1.51970317e-03, 3.00148261e-02, -1.45634113e-03, 4.00019663e-02, -1.37054228e-03, 4.99838040e-02, -1.26250224e-03, 5.99580624e-02, -1.13211814e-03, 6.99248122e-02, -9.79764750e-04, 7.98837933e-02, -8.05060209e-04, 8.98343384e-02, -6.08036498e-04, 9.97740715e-02, -3.88971596e-04, 1.09702011e-01, -1.47837504e-04, 1.19617729e-01, 1.15808488e-04, 1.29520913e-01, 4.01194450e-04, 1.39409704e-01, 7.08677368e-04, 1.49284114e-01, 1.03813249e-03, 1.59146880e-01, 1.38981850e-03, 1.68989012e-01, 1.76347834e-03, 1.78818127e-01, 2.15898483e-03, 1.88627122e-01, 2.57612951e-03, 1.98418539e-01, 3.01516564e-03, 2.08188872e-01, 3.47646201e-03, 2.17940201e-01, 3.95896965e-03, 2.27667616e-01, 4.46383886e-03, 2.37375544e-01, 4.98986107e-03, 2.47059117e-01, 5.53781937e-03, 2.56720982e-01, 6.10740690e-03, 2.66357308e-01, 6.69824683e-03, 2.75969964e-01, 7.31103310e-03, 2.85556946e-01, 7.94419890e-03, 2.95117475e-01, 8.59935677e-03, 3.04652393e-01, 9.27628822e-03, 3.14160183e-01, 9.97373117e-03, 3.23637796e-01, 1.06914036e-02, 3.33087957e-01, 1.14310033e-02, 3.42508365e-01, 1.21904516e-02, 3.51898537e-01, 1.29711261e-02, 3.61258287e-01, 1.37713232e-02, 3.70587525e-01, 1.45935829e-02, 3.79886014e-01, 1.54347210e-02, 
        3.89151758e-01, 1.62963235e-02, 3.98383300e-01, 1.71777874e-02, 4.07580951e-01, 1.80791982e-02, 4.16745008e-01, 1.90003841e-02, 4.25875130e-01, 1.99424606e-02, 4.34967861e-01, 2.09025020e-02, 4.44028152e-01, 2.18821912e-02, 4.53051159e-01, 2.28807600e-02, 4.62037794e-01, 2.38983975e-02, 4.70988124e-01, 2.49356155e-02, 4.79898469e-01, 2.59908116e-02, 4.88771941e-01, 2.70642284e-02, 4.97607719e-01, 2.81551538e-02, 5.06404878e-01, 2.92659606e-02, 5.15163362e-01, 3.03940074e-02, 5.23880797e-01, 3.15395078e-02, 5.32559282e-01, 3.27022979e-02, 5.41196088e-01, 3.38831169e-02, 5.49794405e-01, 3.50816201e-02, 5.58350216e-01, 3.62972805e-02, 5.66865115e-01, 3.75278882e-02, 5.75339196e-01, 3.87770209e-02, 5.83770815e-01, 4.00427897e-02, 5.92160108e-01, 4.13239918e-02, 6.00505998e-01, 4.26220523e-02, 6.08809015e-01, 4.39347818e-02, 6.17072656e-01, 4.52648556e-02, 6.25288552e-01, 4.66090898e-02, 6.33461757e-01, 4.79697654e-02, 6.41591529e-01, 4.93444936e-02, 6.49677602e-01, 5.07340282e-02, 6.57719324e-01, 5.21383591e-02, 6.65716883e-01, 5.35566707e-02, 6.73668317e-01, 5.49892781e-02, 6.81575862e-01, 5.64362078e-02, 6.89437952e-01, 5.78970275e-02, 6.97254167e-01, 
        5.93717225e-02, 7.05025180e-01, 6.08592335e-02, 7.12749243e-01, 6.23601289e-02, 7.20428809e-01, 6.38749835e-02, 7.28062172e-01, 6.54014200e-02, 7.35648913e-01, 6.69408784e-02, 7.43190505e-01, 6.84924353e-02, 7.50685219e-01, 7.00565635e-02, 7.58131841e-01, 7.16320560e-02, 7.65531372e-01, 7.32193362e-02, 7.72885335e-01, 7.48192001e-02, 7.80193523e-01, 7.64288108e-02, 7.87453466e-01, 7.80503373e-02, 7.94665507e-01, 7.96812294e-02, 8.01830656e-01, 8.13233971e-02, 8.08949759e-01, 8.29760788e-02, 8.16020002e-01, 8.46387794e-02, 8.23043863e-01, 8.63114676e-02, 8.30019084e-01, 8.79944664e-02, 8.36947391e-01, 8.96828069e-02, 8.43828731e-01, 9.13823670e-02, 8.50662218e-01, 9.30929158e-02, 8.57446956e-01, 9.48127067e-02, 8.63743531e-01, 9.67003372e-02, 8.69716158e-01, 9.88748876e-02, 8.75362812e-01, 1.01101589e-01, 8.81063316e-01, 1.03177117e-01, 8.86827683e-01, 1.05468398e-01, 8.92514047e-01, 1.07591046e-01, 8.97871092e-01, 1.10013792e-01, 9.03443496e-01, 1.12075400e-01, 9.08822241e-01, 1.14308123e-01, 9.14223397e-01, 1.16646396e-01, 9.19447162e-01, 1.18809248e-01, 9.24685299e-01, 1.21033717e-01, 9.30014332e-01, 1.23313218e-01, 9.34984891e-01, 1.25593674e-01, 
        9.40091795e-01, 1.27911595e-01, 9.44971482e-01, 1.30281268e-01, 9.49866137e-01, 1.32395211e-01, 9.54846512e-01, 1.34580746e-01, 9.59619694e-01, 1.36943232e-01, 9.64279350e-01, 1.39255627e-01, 9.68976753e-01, 1.41461506e-01, 9.73574001e-01, 1.43763856e-01, 9.78149796e-01, 1.45891841e-01, 9.82468354e-01, 1.48187918e-01, 9.86635663e-01, 1.50382398e-01, 9.91038991e-01, 1.52459839e-01, 9.95331395e-01, 1.54895879e-01, 9.99582570e-01, 1.57222050e-01, 1.00372772e+00, 1.59677692e-01, 1.00794548e+00, 1.61849747e-01, 1.01200715e+00, 1.63998006e-01, 1.01585202e+00, 1.66351235e-01, 1.01964427e+00, 1.68739190e-01, 1.02366996e+00, 1.70918184e-01, 1.02733884e+00, 1.73244367e-01, 1.03121868e+00, 1.75690109e-01, 1.03484869e+00, 1.77950351e-01, 1.03845188e+00, 1.80330677e-01, 1.04197094e+00, 1.82493376e-01, 1.04551114e+00, 1.84814496e-01, 1.04890779e+00, 1.87149002e-01, 1.05250748e+00, 1.89459094e-01, 1.05579461e+00, 1.91808293e-01, 1.05899150e+00, 1.93984868e-01, 1.06215360e+00, 1.96485587e-01, 1.06533462e+00, 1.98624953e-01, 1.06842729e+00, 2.00978034e-01, 1.07148030e+00, 2.03173819e-01, 1.07436634e+00, 2.05519876e-01, 1.07742871e+00, 2.07923741e-01, 1.08015007e+00, 
        2.10327161e-01, 1.08301867e+00, 2.12595431e-01, 1.08581889e+00, 2.14953342e-01, 1.08842150e+00, 2.17171844e-01, 1.09107413e+00, 2.19528692e-01, 1.09352656e+00, 2.22008918e-01, 1.09609643e+00, 2.24546703e-01, 1.09855676e+00, 2.26879161e-01, 1.10088538e+00, 2.29299423e-01, 1.10310012e+00, 2.31700563e-01, 1.10537434e+00, 2.34071775e-01, 1.10748761e+00, 2.36518065e-01, 1.10939984e+00, 2.38707327e-01, 1.11161023e+00, 2.41046013e-01, 1.11373992e+00, 2.43407284e-01, 1.11564539e+00, 2.45815548e-01, 1.11761317e+00, 2.48320953e-01, 1.11948972e+00, 2.50525220e-01, 1.12138504e+00, 2.53023883e-01, 1.12328699e+00, 2.55302840e-01, 1.12488454e+00, 2.57755569e-01, 1.12650562e+00, 2.60186552e-01, 1.12819251e+00, 2.62518864e-01, 1.12991097e+00, 2.64824605e-01, 1.13144188e+00, 2.67402132e-01, 1.13281440e+00, 2.69584658e-01, 1.13443024e+00, 2.72183667e-01, 1.13592695e+00, 2.74612406e-01, 1.13710084e+00, 2.76955674e-01, 1.13839412e+00, 2.79105806e-01, 1.13982707e+00, 2.81719294e-01, 1.14096360e+00, 2.84150458e-01, 1.14213756e+00, 2.86655420e-01, 1.14319161e+00, 2.88960990e-01, 1.14445850e+00, 2.91371802e-01, 1.14544186e+00, 2.93915391e-01, 1.14653091e+00, 2.96376028e-01, 
        1.14733669e+00, 2.98779688e-01, 1.14854231e+00, 3.01192709e-01, 1.14920972e+00, 3.03669879e-01, 1.15009013e+00, 3.06003661e-01, 1.15120728e+00, 3.08365691e-01, 1.15186549e+00, 3.10879884e-01, 1.15245307e+00, 3.13143695e-01, 1.15319666e+00, 3.15637022e-01, 1.15380337e+00, 3.18056141e-01, 1.15448398e+00, 3.20484878e-01, 1.15497008e+00, 3.22985703e-01, 1.15567736e+00, 3.25304904e-01, 1.15615424e+00, 3.27882184e-01, 1.15638097e+00, 3.30345866e-01, 6.74485452e-01, 1.72034965e+00, -2.48223688e-02, 1.36674666e+00, -4.37295273e-03, -3.13905220e-01, 1.12919063e+01, 9.89815948e+00, 9.12951233e+00, 1.12240648e+01, 1.27887605e+01, 7.39020953e+00, 4.26798525e+00, 2.62568325e+00, 8.23734556e-01, 3.78081763e-01, 3.87825258e-01, 0.00000000e+00, 0.00000000e+00, 0.00000000e+00, 0.00000000e+00
    ])
    state_std: np.ndarray = np.array([
        # 3.37610245e-03, 2.01694235e-02, 3.40490809e-03, 2.01650270e-02, 3.47281608e-03, 2.01571246e-02, 3.54007074e-03, 2.01504496e-02, 3.60583607e-03, 2.01502710e-02, 3.67302443e-03, 2.01631432e-02, 3.73951440e-03, 2.01966732e-02, 3.80579450e-03, 2.02598056e-02, 3.87319331e-03, 2.03620812e-02, 3.93902215e-03, 2.05152515e-02, 4.00987641e-03, 2.07296193e-02, 4.08336655e-03, 2.10173560e-02, 4.15622140e-03, 2.13891472e-02, 4.23335880e-03, 2.18562441e-02, 4.31121315e-03, 2.24281566e-02, 4.39329517e-03, 2.31134628e-02, 4.48618771e-03, 2.39184431e-02, 4.58984845e-03, 2.48477790e-02, 4.70347998e-03, 2.59056209e-02, 4.83294294e-03, 2.70936501e-02, 4.97840066e-03, 2.84119788e-02, 5.14251443e-03, 2.98587022e-02, 5.32410481e-03, 3.14338515e-02, 5.52416313e-03, 3.31328405e-02, 5.74274335e-03, 3.49556349e-02, 5.98793255e-03, 3.68954301e-02, 6.25350327e-03, 3.89524192e-02, 6.54449186e-03, 4.11217827e-02, 6.86283762e-03, 4.33995173e-02, 7.21133529e-03, 4.57838085e-02, 7.58840097e-03, 4.82709302e-02, 8.00037725e-03, 5.08571007e-02, 8.44062961e-03, 5.35421967e-02, 8.91252112e-03, 5.63219973e-02, 9.41843492e-03, 5.91934419e-02, 9.95644868e-03, 6.21562550e-02, 1.05282035e-02, 
        # 6.52061323e-02, 1.11335156e-02, 6.83425142e-02, 1.17752969e-02, 7.15616087e-02, 1.24536893e-02, 7.48634225e-02, 1.31669939e-02, 7.82463217e-02, 1.39146165e-02, 8.17072264e-02, 1.46954720e-02, 8.52465998e-02, 1.55141137e-02, 8.88601013e-02, 1.63671568e-02, 9.25480618e-02, 1.72547796e-02, 9.63085198e-02, 1.81798960e-02, 1.00141036e-01, 1.91415405e-02, 1.04042903e-01, 2.01374840e-02, 1.08014363e-01, 2.11717652e-02, 1.12052196e-01, 2.22404680e-02, 1.16156029e-01, 2.33441526e-02, 1.20325956e-01, 2.44852129e-02, 1.24559872e-01, 2.56639994e-02, 1.28854587e-01, 2.68792551e-02, 1.33211811e-01, 2.81294767e-02, 1.37629941e-01, 2.94176510e-02, 1.42107313e-01, 3.07414302e-02, 1.46642412e-01, 3.21038194e-02, 1.51235092e-01, 3.35041189e-02, 1.55882119e-01, 3.49398152e-02, 1.60586554e-01, 3.64137252e-02, 1.65344404e-01, 3.79254788e-02, 1.70154881e-01, 3.94733819e-02, 1.75018829e-01, 4.10589337e-02, 1.79932564e-01, 4.26810716e-02, 1.84897794e-01, 4.43437887e-02, 1.89912180e-01, 4.60419500e-02, 1.94974350e-01, 4.77780163e-02, 2.00083970e-01, 4.95512404e-02, 2.05241407e-01, 5.13644490e-02, 2.10442403e-01, 5.32141795e-02, 2.15690426e-01, 5.51007116e-02, 2.20984072e-01,
        # 5.70247576e-02, 2.26320007e-01, 5.89883890e-02, 2.31697629e-01, 6.09902214e-02, 2.37115849e-01, 6.30280402e-02, 2.42576136e-01, 6.51047391e-02, 2.48076460e-01, 6.72204949e-02, 2.53612768e-01, 6.93721436e-02, 2.59190225e-01, 7.15616638e-02, 2.64805531e-01, 7.37895638e-02, 2.70457001e-01, 7.60554212e-02, 2.76144086e-01, 7.83575160e-02, 2.81867331e-01, 8.06978659e-02, 2.87623891e-01, 8.30756966e-02, 2.93412188e-01, 8.54908161e-02, 2.99234845e-01, 8.79438132e-02, 3.05092086e-01, 9.04345664e-02, 3.10977626e-01, 9.29608969e-02, 3.16895625e-01, 9.55261428e-02, 3.22842074e-01, 9.81281906e-02, 3.28819373e-01, 1.00766778e-01, 3.34824125e-01, 1.03443033e-01, 3.40856795e-01, 1.06155826e-01, 3.46916237e-01, 1.08904550e-01, 3.53007633e-01, 1.11690704e-01, 3.59124546e-01, 1.14514091e-01, 3.65261222e-01, 1.17372991e-01, 3.71420433e-01, 1.29382278e-01, 3.79948793e-01, 1.52065179e-01, 3.94211024e-01, 1.73518003e-01, 4.07888727e-01, 1.92263271e-01, 4.21689991e-01, 2.09936118e-01, 4.33809504e-01, 2.26055458e-01, 4.46388573e-01, 2.42348617e-01, 4.58975868e-01, 2.55532233e-01, 4.70658444e-01, 2.69783183e-01, 4.82761008e-01, 2.83013215e-01, 4.94370271e-01, 2.96143208e-01, 
        # 5.05846095e-01, 3.09094654e-01, 5.16955535e-01, 3.20150625e-01, 5.27407987e-01, 3.31552436e-01, 5.38114104e-01, 3.43240360e-01, 5.48941832e-01, 3.55057252e-01, 5.59180980e-01, 3.65913348e-01, 5.69684311e-01, 3.76196650e-01, 5.79305076e-01, 3.86900735e-01, 5.89295065e-01, 3.97700249e-01, 5.99382300e-01, 4.07699419e-01, 6.08948371e-01, 4.17545592e-01, 6.18634271e-01, 4.27889398e-01, 6.28047643e-01, 4.37551991e-01, 6.37650663e-01, 4.47815295e-01, 6.47307847e-01, 4.57137417e-01, 6.56255425e-01, 4.66981479e-01, 6.65735213e-01, 4.76248179e-01, 6.74633612e-01, 4.85483962e-01, 6.84152173e-01, 4.94401209e-01, 6.92907971e-01, 5.03122764e-01, 7.01399775e-01, 5.12567770e-01, 7.10209004e-01, 5.21950474e-01, 7.19123193e-01, 5.29843261e-01, 7.27879432e-01, 5.39083202e-01, 7.36328632e-01, 5.47866657e-01, 7.44954557e-01, 5.55664261e-01, 7.53502046e-01, 5.64472283e-01, 7.61752597e-01, 5.72843581e-01, 7.69906809e-01, 5.80954047e-01, 7.78608285e-01, 5.89267476e-01, 7.86742138e-01, 5.96774365e-01, 7.94759978e-01, 6.05262020e-01, 8.02959481e-01, 6.12771671e-01, 8.10847020e-01, 6.21402029e-01, 8.19532582e-01, 6.29537971e-01, 8.27321351e-01, 6.37038428e-01, 8.35546961e-01, 
        # 6.44830635e-01, 8.43339889e-01, 6.52939503e-01, 8.51221734e-01, 6.60599350e-01, 8.59020636e-01, 6.68398555e-01, 8.67186301e-01, 6.76029963e-01, 8.74667928e-01, 6.83524755e-01, 8.82558446e-01, 6.91362232e-01, 8.90463495e-01, 6.98384239e-01, 8.98084141e-01, 7.06312871e-01, 9.05871765e-01, 7.14063690e-01, 9.13769477e-01, 7.21037503e-01, 9.21367116e-01, 7.28277123e-01, 9.29055034e-01, 7.36224037e-01, 9.36638992e-01, 7.43309012e-01, 9.44294821e-01, 7.51221681e-01, 9.51453564e-01, 7.59122286e-01, 9.59197722e-01, 7.65771386e-01, 9.66462383e-01, 7.72990099e-01, 9.73970392e-01, 7.80618324e-01, 9.81430564e-01, 7.87357924e-01, 9.88838099e-01, 7.94513453e-01, 9.96181081e-01, 8.01414756e-01, 1.00340736e+00, 8.08317189e-01, 1.01077841e+00, 8.15407353e-01, 1.01827125e+00, 8.22610507e-01, 1.02535218e+00, 8.29495423e-01, 1.03240359e+00, 8.35935057e-01, 1.03947260e+00, 8.42988817e-01, 1.04688817e+00, 8.49865550e-01, 1.05399672e+00, 8.56194926e-01, 1.06077904e+00, 8.62817514e-01, 1.06783969e+00, 8.69930266e-01, 1.07505967e+00, 8.76744770e-01, 1.08190734e+00, 8.83331625e-01, 1.08899793e+00, 8.89821878e-01, 1.09599449e+00, 8.96395082e-01, 1.10283684e+00, 9.03214715e-01, 
        # 1.10998794e+00, 9.09457514e-01, 1.11660284e+00, 9.16144056e-01, 1.12316011e+00, 9.22526133e-01, 1.13029755e+00, 9.29147631e-01, 1.13713576e+00, 9.35064168e-01, 1.14365895e+00, 9.41937149e-01, 1.15063658e+00, 9.48155272e-01, 1.15727633e+00, 9.54130781e-01, 1.16381226e+00, 9.60764575e-01, 1.17054950e+00, 9.67380678e-01, 1.17737868e+00, 9.73166137e-01, 1.18401929e+00, 9.79580875e-01, 1.19047674e+00, 9.85540541e-01, 1.19703790e+00, 9.91999333e-01, 1.20353601e+00, 9.97832737e-01, 1.21015069e+00, 1.00394000e+00, 1.21667830e+00, 1.01048356e+00, 1.22319337e+00, 7.78704859e+00, 7.91734143e+00, 5.50161832e+00, 6.11094829e+00, 6.81652683e+00, 8.05089539e+00, 7.13040442e+00, 5.81628043e+00, 3.01577558e+00, 1.72912843e+00, 2.75294422e+00, 1.00000000e-06, 1.00000000e-06, 1.00000000e-06, 1.00000000e-06
    
        3.37328658e-03, 2.01344863e-02, 3.40189740e-03, 2.01300927e-02, 3.46961951e-03, 2.01221781e-02, 3.53676721e-03, 2.01154583e-02, 3.60230152e-03, 2.01151822e-02, 3.66916969e-03, 2.01278751e-02, 3.73538025e-03, 2.01611251e-02, 3.80123441e-03, 2.02238186e-02, 3.86827092e-03, 2.03254718e-02, 3.93374743e-03, 2.04777876e-02, 4.00431119e-03, 2.06910324e-02, 4.07747830e-03, 2.09773365e-02, 4.14996071e-03, 2.13473550e-02, 4.22686335e-03, 2.18123137e-02, 4.30434097e-03, 2.23817012e-02, 4.38605999e-03, 2.30640763e-02, 4.47861314e-03, 2.38657201e-02, 4.58198032e-03, 2.47913289e-02, 4.69537304e-03, 2.58450218e-02, 4.82453956e-03, 2.70285272e-02, 4.96965172e-03, 2.83419371e-02, 5.13332922e-03, 2.97834147e-02, 5.31445365e-03, 3.13529754e-02, 5.51412569e-03, 3.30460573e-02, 5.73238039e-03, 3.48626276e-02, 5.97721516e-03, 3.67959110e-02, 6.24238782e-03, 3.88460925e-02, 6.53298139e-03, 4.10083697e-02, 6.85091589e-03, 4.32787192e-02, 7.19890689e-03, 
        4.56553946e-02, 7.57556448e-03, 4.81346478e-02, 7.98712717e-03, 5.07127096e-02, 8.42683978e-03, 5.33894475e-02, 8.89831783e-03, 5.61606310e-02, 9.40367032e-03, 5.90232498e-02, 9.94119306e-03, 6.19769812e-02, 1.05123511e-02, 6.50175783e-02, 1.11171082e-02, 6.81444573e-02, 1.17583151e-02, 7.13538059e-02, 1.24360635e-02, 7.46456870e-02, 1.31486208e-02, 7.80184120e-02, 1.38955442e-02, 8.14689534e-02, 1.46757719e-02, 8.49977861e-02, 1.54936420e-02, 8.86005099e-02, 1.63459413e-02, 9.22775449e-02, 1.72328111e-02, 9.60268224e-02, 1.81571575e-02, 9.98479698e-02, 1.91179108e-02, 1.03738286e-01, 2.01130064e-02, 1.07697987e-01, 2.11464327e-02, 1.11723912e-01, 2.22142816e-02, 1.15815659e-01, 2.33171560e-02, 1.19973296e-01, 2.44573072e-02, 1.24194766e-01, 2.56352031e-02, 1.28476871e-01, 2.68495610e-02, 1.32821311e-01, 2.80988094e-02, 1.37226466e-01, 2.93860846e-02, 1.41690663e-01, 3.07089490e-02, 1.46212499e-01, 3.20703306e-02, 1.50791723e-01, 3.34696662e-02, 1.55425163e-01, 3.49044097e-02, 1.60115848e-01, 3.63773708e-02, 1.64859758e-01, 3.78881318e-02, 1.69656193e-01, 3.94350295e-02, 1.74505931e-01, 4.10196155e-02, 1.79405309e-01, 4.26408562e-02, 1.84355992e-01, 
        4.43025720e-02, 1.89355762e-01, 4.59997428e-02, 1.94403185e-01, 4.77348307e-02, 1.99497926e-01, 4.95070631e-02, 2.04640351e-01, 5.13193084e-02, 2.09826217e-01, 5.31681164e-02, 2.15058960e-01, 5.50536292e-02, 2.20337206e-01, 5.69767719e-02, 2.25657573e-01, 5.89394844e-02, 2.31019572e-01, 6.09403834e-02, 2.36422039e-01, 6.29772703e-02, 2.41866435e-01, 6.50531034e-02, 2.47350765e-01, 6.71679583e-02, 2.52870946e-01, 6.93186466e-02, 2.58432193e-01, 7.15071555e-02, 2.64031190e-01, 7.37342180e-02, 2.69666140e-01, 7.59991742e-02, 2.75336682e-01, 7.83003513e-02, 2.81043240e-01, 8.06397725e-02, 2.86783095e-01, 8.30166835e-02, 2.92554556e-01, 8.54308698e-02, 2.98360273e-01, 8.78830020e-02, 3.04200411e-01, 9.03728993e-02, 3.10068831e-01, 9.28984001e-02, 3.15969566e-01, 9.54628062e-02, 3.21898654e-01, 9.80640018e-02, 3.27858556e-01, 1.00701755e-01, 3.33845826e-01, 1.03377130e-01, 3.39860923e-01, 1.06089090e-01, 3.45902723e-01, 1.08836906e-01, 3.51976370e-01, 1.11622238e-01, 3.58075428e-01, 1.14444737e-01, 3.64194237e-01, 1.17302782e-01, 3.70335521e-01, 1.29247406e-01, 3.78833633e-01, 1.51801417e-01, 3.93171506e-01, 1.73143864e-01, 4.06919423e-01, 1.91799371e-01, 
        4.20782757e-01, 2.09391054e-01, 4.32967083e-01, 2.25439711e-01, 4.45481522e-01, 2.41663548e-01, 4.58122245e-01, 2.54794209e-01, 4.69858767e-01, 2.68987630e-01, 4.82007751e-01, 2.82165687e-01, 4.93661795e-01, 2.95244928e-01, 5.05072898e-01, 3.08146851e-01, 5.16328646e-01, 3.19162498e-01, 5.26720423e-01, 3.30523451e-01, 5.37465084e-01, 3.42168778e-01, 5.48327115e-01, 3.53943097e-01, 5.58602223e-01, 3.64761403e-01, 5.69137292e-01, 3.75009506e-01, 5.78700205e-01, 3.85676977e-01, 5.88722190e-01, 3.96439711e-01, 5.98838475e-01, 4.06406011e-01, 6.08435647e-01, 4.16220412e-01, 6.18149410e-01, 4.26530055e-01, 6.27591147e-01, 4.36162610e-01, 6.37218722e-01, 4.46393384e-01, 6.46898561e-01, 4.55686718e-01, 6.55789654e-01, 4.65499886e-01, 6.65290910e-01, 4.74738651e-01, 6.74213589e-01, 4.83947034e-01, 6.83829494e-01, 4.92838102e-01, 6.92606644e-01, 5.01534860e-01, 7.01043341e-01, 5.10952145e-01, 7.09871335e-01, 5.20307532e-01, 7.18802214e-01, 5.28179639e-01, 7.27649540e-01, 5.37393261e-01, 7.36042156e-01, 5.46152053e-01, 7.44683191e-01, 5.53930561e-01, 7.53245437e-01, 5.62714637e-01, 7.61512039e-01, 5.71064400e-01, 7.69612216e-01, 5.79154537e-01, 7.78325112e-01, 
        5.87447015e-01, 7.86473826e-01, 5.94936342e-01, 7.94506434e-01, 6.03402534e-01, 8.02718460e-01, 6.10895894e-01, 8.10620307e-01, 6.19504401e-01, 8.19312618e-01, 6.27620885e-01, 8.27114890e-01, 6.35105386e-01, 8.35349475e-01, 6.42880379e-01, 8.43090313e-01, 6.50970863e-01, 8.50982865e-01, 6.58613982e-01, 8.58792430e-01, 6.66396892e-01, 8.66965089e-01, 6.74012397e-01, 8.74458876e-01, 6.81492171e-01, 8.82357432e-01, 6.89313486e-01, 8.90269998e-01, 6.96323361e-01, 8.97899561e-01, 7.04235902e-01, 9.05693838e-01, 7.11971171e-01, 9.13537500e-01, 7.18933760e-01, 9.21142961e-01, 7.26161246e-01, 9.28837396e-01, 7.34092670e-01, 9.36428091e-01, 7.41166507e-01, 9.44089706e-01, 7.49064175e-01, 9.51257305e-01, 7.56950486e-01, 9.59005720e-01, 7.63590843e-01, 9.66221525e-01, 7.70798029e-01, 9.73734700e-01, 7.78413307e-01, 9.81199805e-01, 7.85144318e-01, 9.88611765e-01, 7.92289322e-01, 9.95959956e-01, 7.99181346e-01, 1.00319116e+00, 8.06074491e-01, 1.01056609e+00, 8.13155347e-01, 1.01806082e+00, 8.20348500e-01, 1.02514658e+00, 8.27225195e-01, 1.03215089e+00, 8.33658559e-01, 1.03922474e+00, 8.40703292e-01, 1.04664134e+00, 8.47572546e-01, 1.05375381e+00, 8.53896463e-01, 
        1.06054130e+00, 8.60512473e-01, 1.06760508e+00, 8.67617192e-01, 1.07482682e+00, 8.74424653e-01, 1.08167905e+00, 8.81005272e-01, 1.08877090e+00, 8.87490789e-01, 1.09576941e+00, 8.94059277e-01, 1.10256608e+00, 9.00872588e-01, 1.10971783e+00, 9.07111415e-01, 1.11633710e+00, 9.13792641e-01, 1.12289858e+00, 9.20170632e-01, 1.13003549e+00, 9.26787738e-01, 1.13687548e+00, 9.32702100e-01, 1.14340230e+00, 
        9.39569790e-01, 1.15037977e+00, 9.45786154e-01, 1.15697600e+00, 9.51759522e-01, 1.16351521e+00, 9.58389160e-01, 1.17025340e+00, 9.65001576e-01, 1.17708325e+00, 9.70787320e-01, 1.18372505e+00, 9.77199316e-01, 1.19018522e+00, 9.83158387e-01, 1.19674776e+00, 9.89614580e-01, 1.20324746e+00, 9.95447932e-01, 1.20986302e+00, 1.00155548e+00, 1.21634735e+00, 1.00809693e+00, 1.22286338e+00, 1.30910045e+00, 
        1.75601401e+00, 1.83047564e+00, 2.54801227e-01, 3.50177207e+01, 8.83811034e+01, 7.78339670e+00, 7.89396126e+00, 5.56653184e+00, 6.16346241e+00, 6.79358170e+00, 8.04599486e+00, 7.11196687e+00, 5.79756836e+00, 3.00447987e+00, 1.72246235e+00, 2.74201618e+00, 1.00000000e-06, 1.00000000e-06, 1.00000000e-06, 1.00000000e-06
    ])
    policy: PTPolicy = ReinformerPolicy(model, model_path=MODEL_PATH)
    policy.setup(
        eval_batch_size=1,
        max_test_ep_len=max_steps,
        context_len=CONTEXT_LEN,
        state_mean=state_mean, # how to get this when deploy on a real car?
        state_std=state_std, # how to get this when deploy on a real car?
        state_dim=STATE_DIM,
        act_dim=ACT_DIM,
        device=DEVICE,
    )
    # prepare car
    counter: int = 0
    actor_id: int = 0
    dt: float = 0.03
    qlabs: QuanserInteractiveLabs = QuanserInteractiveLabs()
    qlabs.open('localhost')
    car: ReinformerCar = ReinformerCar(
        actor_id=actor_id,
        dt=dt,
        qlabs=qlabs,
        throttle_coeff=0.08,
        steering_coeff=0.5,
    )
    car.setup(
        task=[4, 14, 20, 22, 10],
        waypoints=waypoints, 
        init_waypoint_index=0, 
        policy=policy
    )
    # start the simulation
    while counter <= max_steps:
        car.execute()
        counter += 1

    