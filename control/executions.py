import numpy as np

from qvl.qlabs import QuanserInteractiveLabs

from core.utils.simulation import destroy_map
from core.utils.simulation import prepare_test_environment
from core.policies.pt_policy import PTPolicy
from control.modules import ReinformerCar, ReinformerPolicy
from system.settings import *
from ..reinformer.dataset import D4RLTrajectoryDataset

from ..reinformer.model import ReinFormer


def run_reinformer_car(waypoints: np.ndarray) -> None:
    # # prepare environment
    # destroy_map()
    # waypoints: np.ndarray = prepare_test_environment(task)
    # nn module
    model: ReinFormer = ReinFormer(
        state_dim=STATE_DIM,
        act_dim=ACT_DIM,
        n_blocks=N_BLOCKS,
        h_dim=EMBED_DIM,
        context_len=CONTEXT_LEN,
        n_heads=N_HEADS,
        drop_p=DROPOUT_P,
        init_temperature=INIT_TEMPERATURE,
        target_entropy=-ACT_DIM,
    ).to(DEVICE)
    # prepare policy
    max_steps: int = 100000
    state_mean: np.ndarray = np.array([
        -1.08756635e-03, 2.36067731e-02, 8.86436995e-03, 2.37184586e-02, 1.87715508e-02, 2.39270152e-02, 2.86851382e-02, 2.42275165e-02, 3.85755884e-02, 2.46222936e-02, 4.84706942e-02, 2.51081301e-02, 5.83387791e-02, 2.56887408e-02, 6.82098204e-02, 2.63600515e-02, 7.80528997e-02, 2.71242785e-02, 8.78941654e-02, 2.79808607e-02, 9.77060907e-02, 2.89285774e-02, 1.07513846e-01, 2.99684909e-02, 1.17283985e-01, 3.10993603e-02, 1.27039662e-01, 3.23229402e-02, 1.36758178e-01, 3.36375196e-02, 1.46461282e-01, 3.50432717e-02, 1.56116273e-01, 3.65404103e-02, 1.65747844e-01, 3.81283575e-02, 1.75329857e-01, 3.98069712e-02, 1.84886446e-01, 4.15750501e-02, 1.94391939e-01, 4.34328542e-02, 2.03868024e-01, 4.53793363e-02, 2.13290760e-01, 4.74147160e-02, 2.22685026e-01, 4.95374289e-02, 2.32020768e-01, 5.17492132e-02, 2.41329820e-01, 5.40456885e-02, 2.50575481e-01, 5.64304705e-02, 2.59793740e-01, 5.88998576e-02, 2.68945569e-01, 6.14561316e-02, 2.78068026e-01, 6.40958138e-02, 2.87124315e-01, 6.68202285e-02, 2.96145865e-01, 6.96276822e-02, 3.05106093e-01, 7.25191866e-02, 3.14022126e-01, 7.54925153e-02, 3.22879422e-01, 7.85482580e-02, 3.31689684e-01, 8.16835141e-02, 3.40440359e-01, 8.49023230e-02, 3.49142040e-01, 8.81981009e-02, 3.57780184e-01, 9.15750184e-02, 3.66371337e-01, 9.50297888e-02, 3.74899478e-01, 9.85613310e-02, 3.83369497e-01, 1.02173091e-01, 3.91777127e-01, 1.05859306e-01, 4.00136449e-01, 1.09621919e-01, 4.08423713e-01, 1.13460036e-01, 4.16663460e-01, 1.17371566e-01, 4.24827672e-01, 1.21357266e-01, 4.32940001e-01, 1.25417660e-01, 4.40974952e-01, 1.29547086e-01, 4.48953461e-01, 1.33750661e-01, 4.56864661e-01, 1.38022640e-01, 4.64701621e-01, 1.42367977e-01, 4.72496732e-01, 1.46778217e-01, 4.80187345e-01, 1.51262731e-01, 4.87850047e-01, 1.55808879e-01, 4.95407023e-01, 1.60428524e-01, 5.02936231e-01, 1.65110002e-01, 5.10367698e-01, 1.69861295e-01, 5.17745809e-01, 1.74675125e-01, 5.25047208e-01, 1.79554248e-01, 5.32294594e-01, 1.84497638e-01, 5.39440510e-01, 1.89503512e-01, 5.46554368e-01, 1.94572223e-01, 5.53573405e-01, 1.99703358e-01, 5.60545052e-01, 2.04895484e-01, 5.67423322e-01, 2.10148678e-01, 5.74248979e-01, 2.15462016e-01, 5.80995855e-01, 2.20836349e-01, 5.87741106e-01, 2.26269795e-01, 5.94312708e-01, 2.31762833e-01, 6.00814349e-01, 2.37317841e-01, 6.07237384e-01, 2.42926530e-01, 6.13588295e-01, 2.48597390e-01, 6.19863778e-01, 2.54320254e-01, 6.26065684e-01, 2.60102189e-01, 6.32188358e-01, 2.65932750e-01, 6.38240576e-01, 2.71825550e-01, 6.44210029e-01, 2.77760295e-01, 6.50115214e-01, 2.83753834e-01, 6.55929082e-01, 2.89793219e-01, 6.61674730e-01, 2.95884708e-01, 6.67341212e-01, 3.02022729e-01, 6.72927168e-01, 3.08209768e-01, 6.78448660e-01, 3.14442185e-01, 6.83872384e-01, 3.20720582e-01, 6.89241189e-01, 3.27043742e-01, 6.94509032e-01, 3.33409106e-01, 6.99721465e-01, 3.39820049e-01, 7.04833474e-01, 3.46269581e-01, 7.09887308e-01, 3.52760647e-01, 7.14846000e-01, 3.59293959e-01, 7.19743411e-01, 3.65864237e-01, 7.24541703e-01, 3.72472269e-01, 7.29284809e-01, 3.79119190e-01, 7.33923959e-01, 3.85801255e-01, 7.38511562e-01, 3.92518771e-01, 7.42988120e-01, 3.99269365e-01, 7.47420830e-01, 4.06057213e-01, 7.51745225e-01, 4.12875587e-01, 7.56011837e-01, 4.19725443e-01, 7.60183270e-01, 4.26608131e-01, 7.64291298e-01, 4.33518868e-01, 7.68303455e-01, 4.40461524e-01, 7.72252215e-01, 4.47428043e-01, 7.76109293e-01, 4.54429848e-01, 7.79895100e-01, 4.61447929e-01, 7.83602153e-01, 4.68505046e-01, 7.87223925e-01, 4.75571172e-01, 7.90773247e-01, 4.82679400e-01, 7.94240052e-01, 4.89794393e-01, 7.97633319e-01, 4.96948459e-01, 8.00934521e-01, 5.04107715e-01, 8.04177076e-01, 5.11304364e-01, 8.07321672e-01, 5.18506974e-01, 8.10403981e-01, 5.25742173e-01, 8.13390155e-01, 5.32981216e-01, 8.16320877e-01, 5.40253014e-01, 8.19148222e-01, 5.47530327e-01, 8.21920540e-01, 5.54834094e-01, 8.24593281e-01, 5.62143493e-01, 8.27205783e-01, 5.69477482e-01, 8.29729438e-01, 5.76817030e-01, 8.32181952e-01, 5.84177284e-01, 8.34550212e-01, 5.91543472e-01, 8.36847552e-01, 5.98925426e-01, 8.39060151e-01, 6.06316820e-01, 8.41209954e-01, 6.13719317e-01, 8.43259261e-01, 6.21130687e-01, 8.45261243e-01, 6.28554281e-01, 8.47150520e-01, 6.35978259e-01, 8.49003495e-01, 6.43418556e-01, 8.50743638e-01, 6.50862152e-01, 8.52436996e-01, 6.58309814e-01, 8.54030071e-01, 6.65763302e-01, 8.55564503e-01, 6.73224558e-01, 8.57014421e-01, 6.80684787e-01, 8.58393392e-01, 6.88154938e-01, 8.59693470e-01, 6.95622120e-01, 8.60920846e-01, 7.03097937e-01, 8.62079467e-01, 7.10566726e-01, 8.63144239e-01, 7.18039464e-01, 8.64152489e-01, 7.25522066e-01, 8.65078746e-01, 7.32983062e-01, 8.65933167e-01, 7.40457579e-01, 8.66718849e-01, 7.47923646e-01, 8.67426289e-01, 7.55384657e-01, 8.68062314e-01, 7.62843916e-01, 8.68626585e-01, 7.70303699e-01, 8.69120102e-01, 7.77749649e-01, 8.69534563e-01, 7.85195635e-01, 8.69888099e-01, 7.92625163e-01, 8.70153821e-01, 8.00054740e-01, 8.70369076e-01, 8.07480879e-01, 8.70495684e-01, 8.14891566e-01, 8.70564055e-01, 8.22301483e-01, 8.70554626e-01, 8.29698965e-01, 8.70475387e-01, 8.37085731e-01, 8.70334652e-01, 8.44462173e-01, 8.70107588e-01, 8.51826686e-01, 8.69839875e-01, 8.59180962e-01, 8.69460110e-01, 8.66518803e-01, 8.69068151e-01, 8.73846116e-01, 8.68544594e-01, 8.81163301e-01, 8.68021739e-01, 8.88467742e-01, 8.67357857e-01, 8.95745612e-01, 8.66703766e-01, 9.03020824e-01, 8.65904699e-01, 9.10264625e-01, 8.65117580e-01, 9.17504631e-01, 8.64185623e-01, 9.24720676e-01, 8.63263719e-01, 9.31920166e-01, 8.62209917e-01, 9.39098266e-01, 8.61157674e-01, 9.46263486e-01, 8.59974630e-01, 9.53400074e-01, 8.58789602e-01, 9.60523815e-01, 8.57487769e-01, 9.67614823e-01, 8.56176406e-01, 9.74707748e-01, 8.54739928e-01, 9.81746476e-01, 8.53312395e-01, 9.88793949e-01, 8.51745437e-01, 9.95786940e-01, 8.50202730e-01, 1.00279415e+00, 8.48509621e-01, 1.00972778e+00, 8.46853044e-01, 1.01669606e+00, 8.45023234e-01, 1.02356428e+00, 8.43271194e-01, 1.03050111e+00, 8.41298236e-01, 1.03729618e+00, 8.39451002e-01, 1.04419984e+00, 8.37345265e-01, 1.05091285e+00, 8.35401998e-01, 1.05779670e+00, 8.33159256e-01, 1.06441391e+00, 8.31125242e-01, 1.07128203e+00, 8.28738438e-01, 1.07778875e+00, 8.26638069e-01, 1.08466780e+00, 8.24089953e-01, 1.09103392e+00, 8.21938537e-01, 1.09793899e+00, 8.19215807e-01, 1.10411830e+00, 8.17043390e-01, 1.11110171e+00, 8.14108805e-01, 1.11706997e+00, 8.11962638e-01, 1.12417805e+00, 8.08749976e-01, 1.12984439e+00, 8.06864342e-01, 1.13731646e+00
    ])
    state_std: np.ndarray = np.array([
        1.47824600e-02, 3.81765470e-02, 1.53668307e-02, 3.82229799e-02, 1.59760720e-02, 3.82995256e-02, 1.66046745e-02, 3.84121792e-02, 1.72471342e-02, 3.85589509e-02, 1.78962220e-02, 3.87422734e-02, 1.85720017e-02, 3.89655995e-02, 1.92548491e-02, 3.92276526e-02, 1.99440872e-02, 3.95346172e-02, 2.06631875e-02, 3.98863387e-02, 2.13716244e-02, 4.02833941e-02, 2.21132475e-02, 4.07309382e-02, 2.28472422e-02, 4.12271802e-02, 2.36092434e-02, 4.17755760e-02, 2.43672056e-02, 4.23768203e-02, 2.51551231e-02, 4.30341117e-02, 2.59477299e-02, 4.37455102e-02, 2.67844845e-02, 4.45139425e-02, 2.76265564e-02, 4.53398629e-02, 2.85117757e-02, 4.62240642e-02, 2.94159239e-02, 4.71658883e-02, 3.03616889e-02, 4.81667729e-02, 3.13306158e-02, 4.92262232e-02, 3.23409775e-02, 5.03456613e-02, 3.33907078e-02, 5.15214902e-02, 3.44590197e-02, 5.27581656e-02, 3.55813458e-02, 5.40493498e-02, 3.67215843e-02, 5.54011418e-02, 3.79186530e-02, 5.68054717e-02, 3.91343093e-02, 5.82670457e-02, 4.03951036e-02, 5.97803745e-02, 4.16852699e-02, 6.13500116e-02, 4.30170887e-02, 6.29692462e-02, 4.43805321e-02, 6.46409197e-02, 4.57884673e-02, 6.63605157e-02, 4.72080338e-02, 6.81298276e-02, 4.86908374e-02, 6.99447896e-02, 5.01822003e-02, 7.18069659e-02, 5.17234896e-02, 7.37107967e-02, 5.32968225e-02, 7.56589172e-02, 5.48727893e-02, 7.76487343e-02, 5.65289238e-02, 7.96770927e-02, 5.81767829e-02, 8.17442623e-02, 5.98775834e-02, 8.38499461e-02, 6.15939252e-02, 8.59894253e-02, 6.33542042e-02, 8.81647985e-02, 6.51265564e-02, 9.03735632e-02, 6.69578773e-02, 9.26106549e-02, 6.87800550e-02, 9.48811319e-02, 7.06563128e-02, 9.71790560e-02, 7.25385679e-02, 9.95052222e-02, 7.44816019e-02, 1.01855484e-01, 7.63948682e-02, 1.04234473e-01, 7.84055965e-02, 1.06630870e-01, 8.03715264e-02, 1.09055121e-01, 8.24256805e-02, 1.11493841e-01, 8.44440120e-02, 1.13957868e-01, 8.65634272e-02, 1.16433142e-01, 8.86259501e-02, 1.18930351e-01, 9.07898710e-02, 1.21438120e-01, 9.29117431e-02, 1.23963152e-01, 9.51156107e-02, 1.26497133e-01, 9.72883435e-02, 1.29045491e-01, 9.95514366e-02, 1.31600931e-01, 1.01780399e-01, 1.34166127e-01, 1.04079735e-01, 1.36736298e-01, 1.06371410e-01, 1.39312082e-01, 1.08709581e-01, 1.41891612e-01, 1.11112338e-01, 1.44470257e-01, 1.13458453e-01, 1.47049507e-01, 1.15837051e-01, 1.49623508e-01, 1.18215310e-01, 1.52198147e-01, 1.20636131e-01, 1.54764730e-01, 1.23056502e-01, 1.57330763e-01, 1.25517835e-01, 1.59887637e-01, 1.27971591e-01, 1.62443525e-01, 1.30475410e-01, 1.64988403e-01, 1.32970929e-01, 1.67530488e-01, 1.35485221e-01, 1.70062907e-01, 1.38035749e-01, 1.72588315e-01, 1.40586224e-01, 1.75105538e-01, 1.43159064e-01, 1.77613187e-01, 1.45753726e-01, 1.80112408e-01, 1.48339746e-01, 1.82602913e-01, 1.50977574e-01, 1.85081999e-01, 1.53589381e-01, 1.87554260e-01, 1.56249547e-01, 1.90012978e-01, 1.58895741e-01, 1.92460973e-01, 1.61580164e-01, 1.94899522e-01, 1.64245941e-01, 1.97327010e-01, 1.66954107e-01, 1.99743252e-01, 1.69644444e-01, 2.02146655e-01, 1.72371730e-01, 2.04541798e-01, 1.75079090e-01, 2.06921916e-01, 1.77826355e-01, 2.09292282e-01, 1.80546808e-01, 2.11650353e-01, 1.83316293e-01, 2.13995029e-01, 1.86047843e-01, 2.16331113e-01, 1.88822274e-01, 2.18654890e-01, 1.91577455e-01, 2.20962514e-01, 1.94352654e-01, 2.23265333e-01, 1.97114663e-01, 2.25552430e-01, 1.99905676e-01, 2.27828897e-01, 2.02663603e-01, 2.30096488e-01, 2.05462624e-01, 2.32350193e-01, 2.08225670e-01, 2.34595374e-01, 2.11017514e-01, 2.36828145e-01, 2.13784818e-01, 2.39052244e-01, 2.16577628e-01, 2.41263707e-01, 2.19334161e-01, 2.43470038e-01, 2.22119286e-01, 2.45662447e-01, 2.24885708e-01, 2.47847470e-01, 2.27647943e-01, 2.50023835e-01, 2.30407406e-01, 2.52189791e-01, 2.33159623e-01, 2.54352637e-01, 2.35908229e-01, 2.56500968e-01, 2.38636721e-01, 2.58647746e-01, 2.41378246e-01, 2.60781989e-01, 2.44087861e-01, 2.62916416e-01, 2.46809603e-01, 2.65037517e-01, 2.49503958e-01, 2.67158136e-01, 2.52192612e-01, 2.69271843e-01, 2.54872119e-01, 2.71378439e-01, 2.57533643e-01, 2.73487180e-01, 2.60187860e-01, 2.75583245e-01, 2.62823672e-01, 2.77683673e-01, 2.65436685e-01, 2.79773272e-01, 2.68055267e-01, 2.81871287e-01, 2.70629673e-01, 2.83958442e-01, 2.73219510e-01, 2.86050330e-01, 2.75754353e-01, 2.88135330e-01, 2.78308075e-01, 2.90227814e-01, 2.80809109e-01, 2.92310279e-01, 2.83316170e-01, 2.94405919e-01, 2.85788804e-01, 2.96490997e-01, 2.88242213e-01, 2.98589441e-01, 2.90681761e-01, 3.00676688e-01, 2.93088007e-01, 3.02783221e-01, 2.95483982e-01, 3.04875491e-01, 2.97835555e-01, 3.06986105e-01, 3.00197670e-01, 3.09089209e-01, 3.02504240e-01, 3.11215823e-01, 3.04805393e-01, 3.13320731e-01, 3.07066960e-01, 3.15455581e-01, 3.09314497e-01, 3.17574771e-01, 3.11516826e-01, 3.19719943e-01, 3.13716578e-01, 3.21854527e-01, 3.15869446e-01, 3.24009262e-01, 3.18002002e-01, 3.26163094e-01, 3.20107325e-01, 3.28331779e-01, 3.22179085e-01, 3.30498585e-01, 3.24227406e-01, 3.32688415e-01, 3.26242172e-01, 3.34874934e-01, 3.28226115e-01, 3.37074378e-01, 3.30184625e-01, 3.39285690e-01, 3.32106941e-01, 3.41502481e-01, 3.34008379e-01, 3.43736020e-01, 3.35861104e-01, 3.45967999e-01, 3.37711320e-01, 3.48225269e-01, 3.39487818e-01, 3.50475483e-01, 3.41292328e-01, 3.52758177e-01, 3.42987224e-01, 3.55027091e-01, 3.44743712e-01, 3.57330993e-01, 3.46366340e-01, 3.59625943e-01, 3.48066336e-01, 3.61949071e-01, 3.49615330e-01, 3.64272595e-01, 3.51261673e-01, 3.66609950e-01, 3.52742498e-01, 3.68961556e-01, 3.54323698e-01, 3.71323395e-01, 3.55746083e-01, 3.73696956e-01, 3.57247062e-01, 3.76080936e-01, 3.58615583e-01, 3.78472865e-01, 3.60046612e-01, 3.80883202e-01, 3.61358572e-01, 3.83299126e-01, 3.62718409e-01, 3.85727713e-01, 3.63970916e-01, 3.88164031e-01, 3.65273577e-01, 3.90620896e-01, 3.66457978e-01, 3.93070830e-01, 3.67706576e-01, 3.95553585e-01, 3.68822271e-01, 3.98021166e-01, 3.70017759e-01, 4.00521386e-01, 3.71063802e-01, 4.03013449e-01, 3.72222461e-01, 4.05526565e-01, 3.73182411e-01, 4.08039777e-01, 3.74316456e-01, 4.10565601e-01, 3.75191901e-01, 4.13099747e-01, 3.76295060e-01, 4.15634942e-01, 3.77092445e-01, 4.18192471e-01, 3.78171846e-01, 4.20730964e-01, 3.78892929e-01, 4.23317264e-01, 3.79948348e-01, 4.25855218e-01, 3.80592006e-01, 4.28459042e-01, 3.81624158e-01, 4.31007338e-01, 3.82199173e-01, 4.33609774e-01, 3.83203126e-01, 4.36182946e-01, 3.83711459e-01, 4.38760440e-01, 3.84711520e-01, 4.41393239e-01, 3.85129398e-01, 4.43904295e-01, 3.86167687e-01, 4.46629694e-01, 3.86363809e-01, 4.49013923e-01

    ])
    policy: PTPolicy = ReinformerPolicy(model, model_path=MODEL_PATH)
    policy.setup(
        eval_batch_size=1,
        max_test_ep_len=max_steps,
        context_len=CONTEXT_LEN,
        state_mean=state_mean, # how to get this when deploy on a real car?
        state_std=state_std, # how to get this when deploy on a real car?
        state_dim=STATE_DIM,
        act_dim=ACT_DIM,
        device=DEVICE,
    )
    # prepare car
    counter: int = 0
    actor_id: int = 0
    dt: float = 0.03
    qlabs: QuanserInteractiveLabs = QuanserInteractiveLabs()
    qlabs.open('localhost')
    car: ReinformerCar = ReinformerCar(
        actor_id=actor_id,
        dt=dt,
        qlabs=qlabs,
        throttle_coeff=0.08,
        steering_coeff=0.5,
    )
    car.setup(waypoints=waypoints, init_waypoint_index=0, policy=policy)
    # start the simulation
    while counter <= max_steps:
        car.execute()
        counter += 1

    